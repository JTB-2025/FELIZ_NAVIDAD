<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Feliz Navidad ✨</title>
  <style>
    :root{
      --bg:#000;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.10);
      --border: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 28px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 15% 15%, rgba(190,0,70,.22), transparent 60%),
                  radial-gradient(1200px 900px at 90% 15%, rgba(0,120,255,.16), transparent 55%),
                  #000;
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow:hidden;
    }

    .stage{
      position:relative;
      height:100%;
      width:100%;
      display:grid;
      place-items:center;
      padding: clamp(10px, 2.2vw, 22px);
    }

    .card{
      position:relative;
      width:min(1000px, 96vw);
      height:min(640px, 92vh);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      overflow:hidden;
      padding: clamp(12px, 2.2vw, 18px);
      padding-bottom: clamp(92px, 12vh, 130px);
    }

    canvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      display:block;
    }

    .topbar{
      position:absolute;
      left: clamp(10px, 2vw, 18px);
      right: clamp(10px, 2vw, 18px);
      top: clamp(10px, 2vw, 16px);
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      z-index:5;
      pointer-events:none;
    }

    .tip{
      font-size: clamp(12px, 1.3vw, 14px);
      color: var(--muted);
      text-shadow: 0 8px 30px rgba(0,0,0,.65);
      pointer-events:none;
      padding-top: 2px;
    }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      pointer-events:auto;
    }

    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      color:rgba(255,255,255,.92);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 650;
      font-size: 14px;
      line-height: 1;
      display:flex;
      align-items:center;
      gap:10px;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn:hover{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.18); }

    .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; }
    .dot.red{ background:#ff3b3b; }
    .dot.blue{ background:#4da3ff; }
    .dot.gold{ background:#ffd54a; }

    .footerText{
      position:absolute;
      left: 16px;
      right: 16px;
      bottom: 18px;
      text-align:center;
      z-index:6;
      text-shadow: 0 16px 50px rgba(0,0,0,.75);
      pointer-events:none;
    }

    .sub{
      font-size: clamp(12px, 1.7vw, 16px);
      color: rgba(255,255,255,.78);
      margin:0 0 8px 0;
    }

    .title{
      margin:0;
      font-size: clamp(34px, 6.5vw, 72px);
      letter-spacing: .5px;
      font-weight: 900;
    }

    @media (max-width: 520px){
      .btn{ padding: 9px 12px; font-size: 13px; }
      .card{ padding-bottom: 110px; }
    }
  </style>
</head>
<body>
  <div class="stage">
    <div class="card" id="card">
      <canvas id="c"></canvas>

      <div class="topbar">
        <div class="tip">Tip: toca <b>“Música”</b> para iniciar (autoplay suele bloquearse)</div>
        <div class="controls">
          <button class="btn" id="btnMusic" type="button" aria-pressed="false" title="Reproducir / Pausar música">
            <span class="dot red"></span> Música
          </button>
          <button class="btn" id="btnPause" type="button" aria-pressed="false" title="Pausar / Reanudar animación">
            <span class="dot blue"></span> Pausar
          </button>
          <button class="btn" id="btnGlow" type="button" aria-pressed="false" title="Aumentar brillo de luces">
            <span class="dot gold"></span> Súper brillo
          </button>
        </div>
      </div>

      <div class="footerText">
        <p class="sub">Que tu noche brille con amor, paz y alegría ✨</p>
        <h1 class="title">Feliz Navidad</h1>
      </div>

      <!-- Música local -->
      <audio id="audio" preload="auto" loop>
        <source src="musica.mp3" type="audio/mpeg">
      </audio>

    </div>
  </div>

  <script>
    (() => {
      const canvas = document.getElementById('c');
      const ctx = canvas.getContext('2d', { alpha: true });

      const card = document.getElementById('card');
      const audio = document.getElementById('audio');
      const btnMusic = document.getElementById('btnMusic');
      const btnPause = document.getElementById('btnPause');
      const btnGlow  = document.getElementById('btnGlow');

      // ====== Estado ======
      let dpr = Math.min(2, window.devicePixelRatio || 1);
      let W = 0, H = 0;

      let paused = false;
      let superGlow = false;

      // rotación suave: usamos tiempo real para que no “trabe”
      let t0 = performance.now();
      let rot = 0;

      // Ajuste automático de partículas (móvil vs PC) - MÁS LIGERO PARA QUE NO SE TRABE
      const isMobile = () => Math.min(window.innerWidth, window.innerHeight) < 520;
      let LIGHT_COUNT = isMobile() ? 520 : 1150;
      let SNOW_COUNT  = isMobile() ? 140 : 200;

      // ====== Utilidades ======
      const rand = (a,b)=> a + Math.random()*(b-a);
      const clamp = (v,a,b)=> Math.max(a, Math.min(b,v));

      function resize(){
        const r = card.getBoundingClientRect();
        W = Math.max(320, Math.floor(r.width));
        H = Math.max(420, Math.floor(r.height));
        dpr = Math.min(2, window.devicePixelRatio || 1);

        canvas.width  = Math.floor(W * dpr);
        canvas.height = Math.floor(H * dpr);
        canvas.style.width = W + 'px';
        canvas.style.height = H + 'px';
        ctx.setTransform(dpr,0,0,dpr,0,0);

        // Recalcular densidades cuando cambia tamaño
        LIGHT_COUNT = isMobile() ? 520 : 1150;
        SNOW_COUNT  = isMobile() ? 140 : 200;

        buildTree();
        buildSnow();
      }

      // ====== Árbol de luces (puntos en cono 3D + rotación Y) ======
      let lights = [];
      let star = null;

      function buildTree(){
        lights = [];

        // Árbol centrado SIEMPRE
        const centerX = W * 0.50;
        const baseY   = H * 0.74;

        const treeH = H * 0.55;
        const maxR  = Math.min(W, H) * 0.22;
        const minR  = maxR * 0.02;

        for(let i=0;i<LIGHT_COUNT;i++){
          const yN = Math.pow(Math.random(), 0.55);
          const y = yN * treeH;

          const r = (1 - yN) * maxR + minR;

          const theta = Math.random() * Math.PI * 2;
          const x = Math.cos(theta) * r;
          const z = Math.sin(theta) * r;

          const size = rand(1.2, 2.6) * (1 + (1 - yN) * 0.6);

          const palette = [
            [255, 70, 70],
            [80, 220, 140],
            [80, 160, 255],
            [255, 220, 90],
            [255, 255, 255],
            [255, 120, 220],
            [140, 255, 240]
          ];
          const c = palette[(Math.random()*palette.length)|0];

          lights.push({
            cx:centerX, by:baseY,
            x, y, z,
            yN,
            size,
            c,
            tw: rand(0, Math.PI*2),
            sp: rand(0.7, 1.8)
          });
        }

        star = {
          x: centerX,
          y: baseY - treeH - 18,
          r: Math.max(12, Math.min(W,H) * 0.03),
        };
      }

      // ====== Nieve “natural” ======
      let snow = [];

      function buildSnow(){
        snow = [];
        for(let i=0;i<SNOW_COUNT;i++){
          const layer = Math.random();
          const size = rand(1.3, 4.8) * (0.35 + (1-layer)*0.9);
          snow.push({
            x: rand(0, W),
            y: rand(-H, H),
            vx: rand(-10, 10) * (0.10 + layer*0.35),
            vy: rand(20, 70) * (0.45 + (1-layer)*0.9),
            size,
            a: rand(0.25, 0.85),
            layer,
            wob: rand(0, Math.PI*2),
            wobSp: rand(0.6, 1.6)
          });
        }
      }

      // ====== Proyección 3D simple ======
      function project3D(x,y,z, rotY, centerX, baseY){
        const cos = Math.cos(rotY), sin = Math.sin(rotY);
        const rx = x*cos + z*sin;
        const rz = -x*sin + z*cos;

        const persp = 420;
        const scale = persp / (persp + rz);

        return {
          x: centerX + rx * scale,
          y: baseY - y * scale,
          s: scale,
          z: rz
        };
      }

      // ====== Dibujar estrella ======
      function drawStar(x,y,r, glowBoost){
        const spikes = 5;
        const inner = r*0.45;
        const outer = r;

        ctx.save();
        ctx.translate(x,y);

        ctx.shadowColor = 'rgba(255, 220, 120, .95)';
        ctx.shadowBlur  = glowBoost ? 40 : 26;

        ctx.beginPath();
        let rotA = -Math.PI/2;
        const step = Math.PI / spikes;

        ctx.moveTo(Math.cos(rotA)*outer, Math.sin(rotA)*outer);
        for(let i=0;i<spikes;i++){
          ctx.lineTo(Math.cos(rotA + step)*inner, Math.sin(rotA + step)*inner);
          ctx.lineTo(Math.cos(rotA + step*2)*outer, Math.sin(rotA + step*2)*outer);
          rotA += step*2;
        }
        ctx.closePath();

        const g = ctx.createLinearGradient(0,-outer,0,outer);
        g.addColorStop(0, 'rgba(255,255,255,0.95)');
        g.addColorStop(0.45, 'rgba(255,220,120,0.95)');
        g.addColorStop(1, 'rgba(255,170,60,0.85)');
        ctx.fillStyle = g;
        ctx.fill();

        ctx.restore();
      }

      // ====== Dibujar tronco ======
      function drawTrunk(centerX, baseY){
        const tw = Math.max(34, Math.min(W,H) * 0.06);
        const th = Math.max(64, Math.min(W,H) * 0.11);

        const x = centerX - tw/2;
        const y = baseY + 6;

        ctx.save();
        ctx.shadowColor = 'rgba(0,0,0,.6)';
        ctx.shadowBlur = 16;
        const grd = ctx.createLinearGradient(x, y, x+tw, y+th);
        grd.addColorStop(0, 'rgba(170, 90, 25, .95)');
        grd.addColorStop(1, 'rgba(110, 55, 15, .95)');
        ctx.fillStyle = grd;

        const r = Math.min(12, tw*0.35);
        roundRect(ctx, x, y, tw, th, r);
        ctx.fill();
        ctx.restore();
      }

      function roundRect(c, x, y, w, h, r){
        const rr = Math.min(r, w/2, h/2);
        c.beginPath();
        c.moveTo(x+rr, y);
        c.arcTo(x+w, y, x+w, y+h, rr);
        c.arcTo(x+w, y+h, x, y+h, rr);
        c.arcTo(x, y+h, x, y, rr);
        c.arcTo(x, y, x+w, y, rr);
        c.closePath();
      }

      // ====== Fondo ======
      function drawBackground(){
        ctx.clearRect(0,0,W,H);
        const g = ctx.createRadialGradient(W*0.5, H*0.45, 40, W*0.5, H*0.45, Math.max(W,H)*0.85);
        g.addColorStop(0, 'rgba(0,0,0,0.10)');
        g.addColorStop(0.55, 'rgba(0,0,0,0.65)');
        g.addColorStop(1, 'rgba(0,0,0,0.88)');
        ctx.fillStyle = g;
        ctx.fillRect(0,0,W,H);
      }

      // ====== Nieve ======
      function drawSnow(dt){
        for(const p of snow){
          p.wob += dt * p.wobSp;
          p.x += (p.vx + Math.sin(p.wob)*18*(0.2+p.layer*0.4)) * dt;
          p.y += p.vy * dt;

          if(p.y > H + 20){ p.y = -20; p.x = rand(0,W); }
          if(p.x < -20) p.x = W + 20;
          if(p.x > W + 20) p.x = -20;

          ctx.save();
          ctx.globalAlpha = p.a;

          const blur = (1 - p.layer) * 10 + 2;
          ctx.shadowColor = 'rgba(255,255,255,.9)';
          ctx.shadowBlur = blur;

          ctx.fillStyle = 'rgba(255,255,255,.85)';
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
          ctx.fill();
          ctx.restore();
        }
      }

      // ====== Árbol ======
      function drawTree(time){
        const centerX = W * 0.50;
        const baseY   = H * 0.74;

        drawStar(star.x, star.y, star.r, superGlow);

        const localRot = rot;
        const projected = lights.map(L => {
          const p = project3D(L.x, L.y, L.z, localRot, centerX, baseY);
          return { L, p };
        }).sort((a,b)=> a.p.z - b.p.z);

        for(const {L, p} of projected){
          const tw = 0.55 + 0.45*Math.sin(time*L.sp + L.tw);
          const glow = (superGlow ? 24 : 15) * p.s;
          const radius = L.size * (0.95 + tw*0.35) * p.s;

          const [r,g,b] = L.c;
          ctx.save();
          ctx.globalAlpha = 0.35 + tw*0.55;

          ctx.shadowColor = `rgba(${r},${g},${b},.95)`;
          ctx.shadowBlur  = glow;

          ctx.fillStyle = `rgba(${r},${g},${b},.92)`;
          ctx.beginPath();
          ctx.arc(p.x, p.y, radius, 0, Math.PI*2);
          ctx.fill();

          ctx.globalAlpha = 0.22 + tw*0.35;
          ctx.shadowBlur = glow*0.55;
          ctx.fillStyle = 'rgba(255,255,255,.9)';
          ctx.beginPath();
          ctx.arc(p.x, p.y, radius*0.42, 0, Math.PI*2);
          ctx.fill();

          ctx.restore();
        }

        drawTrunk(centerX, baseY);
      }

      // ====== Loop ======
      function tick(now){
        const dt = clamp((now - t0) / 1000, 0, 0.033);
        t0 = now;

        if(!paused){
          const speed = 0.65;
          rot += dt * speed;
        }

        drawBackground();
        drawSnow(dt);
        drawTree(now / 1000);

        requestAnimationFrame(tick);
      }

      // ====== Música (CORREGIDO: evita AbortError por clicks rápidos / play interrumpido) ======
      let musicBusy = false;
      async function toggleMusic(){
        if (musicBusy) return;
        musicBusy = true;

        try{
          if(audio.paused){
            audio.muted = false;

            const p = audio.play();
            if (p && typeof p.then === "function") await p;

            btnMusic.setAttribute('aria-pressed', 'true');
          }else{
            audio.pause();
            btnMusic.setAttribute('aria-pressed', 'false');
          }
        }catch(e){
          if (e && e.name === "AbortError") {
            try{
              await new Promise(r => setTimeout(r, 120));
              const p2 = audio.play();
              if (p2 && typeof p2.then === "function") await p2;
              btnMusic.setAttribute('aria-pressed', 'true');
            }catch(_e2){
              console.log('Audio play blocked:', _e2);
            }
          } else {
            console.log('Audio play blocked:', e);
          }
        }finally{
          setTimeout(()=>{ musicBusy = false; }, 250);
        }
      }

      function togglePause(){
        paused = !paused;
        btnPause.setAttribute('aria-pressed', String(paused));
        btnPause.innerHTML = `<span class="dot blue"></span> ${paused ? 'Reanudar' : 'Pausar'}`;
      }

      function toggleGlow(){
        superGlow = !superGlow;
        btnGlow.setAttribute('aria-pressed', String(superGlow));
      }

      btnMusic.addEventListener('click', toggleMusic);
      btnPause.addEventListener('click', togglePause);
      btnGlow.addEventListener('click', toggleGlow);

      window.addEventListener('resize', resize);

      resize();
      requestAnimationFrame(tick);
    })();
  </script>
</body>
</html>
